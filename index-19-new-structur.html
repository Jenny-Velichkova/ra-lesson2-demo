<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RA Exercises ‚Äì Speaking Module</title>
<style>
  :root{--w:980px;}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:#0b0e12;
    color:#e7e9ee;
    margin:0;
    padding:16px;
  }
  .wrap{max-width:var(--w);margin:0 auto;}
  .head{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px
  }
  .pills{display:flex;gap:6px;flex-wrap:wrap}
  .pill{
    font-size:12px;
    background:#1a2230;
    border:1px solid #2b3a55;
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    user-select:none
  }
  .pill[aria-pressed="true"]{background:#142034;border-color:#3b5a8f}
  h1{font-size:18px;margin:0}
  .card{
    background:#10161f;
    border:1px solid #223047;
    border-radius:14px;
    padding:16px;
    margin:12px 0;
    box-shadow:0 2px 10px rgba(0,0,0,.25)
  }
  .block-title{font-weight:700;margin:0 0 6px 0}
  .block-sub{color:#9aa7bd;font-size:13px;margin-bottom:10px;white-space:pre-line}
  .prompt{font-weight:600;margin-bottom:10px}
  .controls{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
    align-items:center
  }
  button{
    cursor:pointer;
    border:1px solid #314462;
    background:#172133;
    color:#e7e9ee;
    border-radius:10px;
    padding:8px 12px
  }
  button:hover{background:#1e2a40}
  input[type="text"]{
    width:100%;
    max-width:420px;
    background:#0e131b;
    border:1px solid #32445f;
    color:#fff;
    border-radius:10px;
    padding:8px 10px
  }
  .ok{color:#6ee7a8}
  .bad{color:#fca5a5}
  .muted{color:#9aa7bd;font-size:13px}
  .note{font-size:13px;color:#c9d6f2}
  .hr{height:1px;background:#1f2a3d;margin:18px 0}
  .foot{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:flex-end
  }
  .listening{
    border-color:#3a7bd5;
    box-shadow:0 0 0 2px rgba(58,123,213,.15) inset
  }
  .wave{
    width:10px;
    height:10px;
    border-radius:999px;
    background:#4da3ff;
    display:inline-block;
    animation:pulse 1.2s infinite ease-in-out;
    margin-left:6px
  }
  @keyframes pulse{
    0%{transform:scale(.9);opacity:.6}
    50%{transform:scale(1.2);opacity:1}
    100%{transform:scale(.9);opacity:.6}
  }
  .kbd{
    font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    background:#0b1220;
    border:1px solid #2a3b57;
    padding:0 6px;
    border-radius:6px;
    font-size:.9em
  }

  /* Reorder UI ‚Äì –í–ï–†–¢–ò–ö–ê–õ–ù–ò –ò–ó–†–ï–ß–ï–ù–ò–Ø */
  .reorder-wrap{
    display:flex;
    flex-direction:column;
    gap:8px
  }
  .bank,.built{
    min-height:46px;
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:8px;
    border:1px dashed #2a3b57;
    border-radius:12px;
    background:#0e141e
  }
  .sentence-token{
    padding:6px 10px;
    border:1px solid #33445f;
    border-radius:10px;
    background:#151e2c;
    user-select:none;
    font-size:14px;
    line-height:1.4;
  }
  .sentence-token:hover{background:#1a2637}
  .reorder-ctrls{display:flex;gap:8px;flex-wrap:wrap}
  .yn-quick{display:flex;gap:8px}

  /* Story content (—Ä–∞–∑–∫–∞–∑—á–µ—Ç–æ) */
  .story-title{
    font-weight:700;
    font-size:16px;
    margin-bottom:8px;
  }
  .story-paragraph{
    margin:4px 0;
    font-size:14px;
    line-height:1.5;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <h1>Interactive Exercises ‚Äì Speaking</h1>
    <div class="pills">
      <div class="pill" id="meta"></div>
      <div class="pill" id="pillSpeech" aria-pressed="true">Speech: ON</div>
      <div class="pill" id="pillTTS" aria-pressed="true">TTS: ON</div>
      <div class="pill" id="pillAutoCheck" aria-pressed="false" title="Auto-check after speech">Auto-check: OFF</div>
      <div class="pill" id="pillAutoMic" aria-pressed="true" title="Auto mic after Listen">Auto-mic: ON</div>
    </div>
  </div>

  <div class="card note" id="howto">
    <strong>–ö–∞–∫ –¥–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏—à / How to answer:</strong><br/>
    –ù–∞—Ç–∏—Å–Ω–∏ <span class="kbd">Listen</span> –∏ —Å–ª–µ–¥ –∫–∞—Ç–æ —á—É–µ—à –∏–∑—Ä–µ—á–µ–Ω–∏–µ—Ç–æ, –∫–∞–∂–∏ –æ—Ç–≥–æ–≤–æ—Ä–∞ –Ω–∞ –≥–ª–∞—Å. –û—Ç–≥–æ–≤–æ—Ä—ä—Ç —â–µ —Å–µ –∏–∑–ø–∏—à–µ –≤ –ø–æ–ª–µ—Ç–æ ‚Äì –º–æ–∂–µ—à –¥–∞ –≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞—à, –ø–æ—Å–ª–µ –Ω–∞—Ç–∏—Å–Ω–∏ <span class="kbd">Check</span>.<br/>
    If you prefer typing, just write your answer instead. <span class="kbd">L</span>=Listen, <span class="kbd">S</span>=Speak, <span class="kbd">Enter</span>=Check, <span class="kbd">Esc</span>=Stop.
  </div>

  <div id="list"></div>

  <div class="hr"></div>
  <div class="foot muted">
    Tip: Use the üîä button to hear the sentence. Your answers are checked locally.
  </div>
</div>

<script>
/* --- 0) URL params + file resolver --- */
const url = new URL(location.href);
const level   = (url.searchParams.get('level')   || 'A1').toUpperCase();
const unit    = (url.searchParams.get('unit')    || 'L2').toUpperCase();
const section = (url.searchParams.get('section') || 'story').toLowerCase();
const typeParam = (url.searchParams.get('type')  || '').toLowerCase(); // 'fill' | 'yesno' | 'reorder'

document.getElementById('meta').textContent = `${level} ‚Ä¢ ${unit} ‚Ä¢ ${section}`;

// –§–∞–π–ª –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ ‚Äì –≥—Ä–∞–º–∞—Ç–∏–∫–∞/—Å—Ç–∞—Ä —Ñ–æ—Ä–º–∞—Ç.
// –ó–∞ story (A1) —â–µ –≥–æ override-–Ω–µ–º –ø–æ-–¥–æ–ª—É (seed.LXX.story.json).
let resolvedFile = url.searchParams.get('file');
if (!resolvedFile) {
  const m = /^L?(\d+)/i.exec(unit);
  const unit2 = m ? String(m[1]).padStart(2, '0') : '01';
  const lvl = level.toLowerCase();

  if (section === 'grammar') {
    resolvedFile = 'data/a1_grammar.json';
  } else if (section === 'story') {
    // –©–µ –∑–∞—Ä–µ–∂–¥–∞–º–µ seed —Ñ–∞–π–ª–æ–≤–µ—Ç–µ, –∞ –Ω–µ —Å—Ç–∞—Ä–∏—Ç–µ full.json
    // –Ω–æ –æ—Å—Ç–∞–≤—è–º–µ fallback –∫—ä–º —Å—Ç–∞—Ä–∏—è full.json, –∞–∫–æ –Ω—è–º–∞ seed.
    resolvedFile = null; // —â–µ —Å–µ –æ–ø—Ä–µ–¥–µ–ª–∏ –≤ loadData
  } else {
    resolvedFile = 'data/a1.json'; // fallback
  }
}

// GH Pages –µ —Å—Ç–∞—Ç–∏—á–µ–Ω ‚Üí AI feedback —Å–∞–º–æ –ª–æ–∫–∞–ª–Ω–æ
const IS_LOCAL = ['localhost','127.0.0.1'].includes(location.hostname);
const API_BASE = IS_LOCAL ? 'http://127.0.0.1:3000' : '';

/* --- Global toggles (with localStorage) --- */
const store = {
  get(k, def){ try{ const v=localStorage.getItem(k); return v===null?def:JSON.parse(v);}catch{ return def; } },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
};
let speechEnabled   = store.get('speechEnabled', true);
let ttsEnabled      = store.get('ttsEnabled', true);
let autoCheck       = store.get('autoCheck', false);
let autoMicAfterListen = store.get('autoMicAfterListen', true);
function syncPills(){
  const pS = document.getElementById('pillSpeech');
  const pT = document.getElementById('pillTTS');
  const pA = document.getElementById('pillAutoCheck');
  const pM = document.getElementById('pillAutoMic');
  pS.setAttribute('aria-pressed', String(speechEnabled)); pS.textContent = `Speech: ${speechEnabled?'ON':'OFF'}`;
  pT.setAttribute('aria-pressed', String(ttsEnabled));    pT.textContent = `TTS: ${ttsEnabled?'ON':'OFF'}`;
  pA.setAttribute('aria-pressed', String(autoCheck));     pA.textContent = `Auto-check: ${autoCheck?'ON':'OFF'}`;
  pM.setAttribute('aria-pressed', String(autoMicAfterListen)); pM.textContent = `Auto-mic: ${autoMicAfterListen?'ON':'OFF'}`;
}
document.getElementById('pillSpeech').onclick   = ()=>{ speechEnabled=!speechEnabled; store.set('speechEnabled', speechEnabled); syncPills(); };
document.getElementById('pillTTS').onclick      = ()=>{ ttsEnabled=!ttsEnabled; store.set('ttsEnabled', ttsEnabled); syncPills(); };
document.getElementById('pillAutoCheck').onclick= ()=>{ autoCheck=!autoCheck; store.set('autoCheck', autoCheck); syncPills(); };
document.getElementById('pillAutoMic').onclick  = ()=>{ autoMicAfterListen=!autoMicAfterListen; store.set('autoMicAfterListen', autoMicAfterListen); syncPills(); };
syncPills();

/* --- 1) TTS helpers --- */
function normalizeForSpeech(t){
  return String(t)
    .replace(/\([^)]*\)/g, ' ')
    .replace(/‚Üí/g, ' to ')
    .replace(/[‚Ä¢‚óÜ‚ó¶‚ñ†\-‚Äì‚Äî]/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .trim();
}
function toInstructionalSpeech(prompt){
  const hasBlank = /_{1,}/.test(prompt||'');
  const clean = normalizeForSpeech(prompt||'');
  if (hasBlank) return "Complete the sentence: " + clean.replace(/_{1,}/g, " ‚Ä¶ ");
  return clean;
}
let preferredVoice = null;
function pickMaleVoice(){
  const voices = window.speechSynthesis.getVoices?.() || [];
  const byMaleName = voices.find(v => /(male|david|george|guy|daniel|microsoft|google uk english male)/i.test(v.name));
  const byLangEN   = voices.find(v => /^en(-|_)/i.test(v.lang));
  preferredVoice = byMaleName || byLangEN || voices[0] || null;
}
window.speechSynthesis.onvoiceschanged = pickMaleVoice; pickMaleVoice();
function say(text, onend){
  if(!ttsEnabled) { onend && setTimeout(onend, 400); return; }
  try{
    const u = new SpeechSynthesisUtterance(normalizeForSpeech(text));
    if (preferredVoice) u.voice = preferredVoice;
    u.rate = 1.0; u.pitch = 1.0;
    if (onend) u.onend = onend;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch{ onend && setTimeout(onend, 400); }
}

/* --- 1a) Smart feedback --- */
function smartWrongFeedback(it){
  const t = (it.prompt || "").toLowerCase();
  if (/\bhave\b|\bhas\b|have\/has/.test(t)) {
    return "Not quite. With 'I, you, we, they' use 'have'; with 'he, she, it' use 'has'. Try repeating the sentence out loud.";
  }
  if (t.includes("plural") || /boxes|buses|churches|tomatoes|classes|wishes/.test(t)) {
    return "Not quite. For nouns ending in -x, -s, -sh, -ch, or -o, add '-es'. Say the plural form out loud.";
  }
  if (/_+/.test(it.prompt || "") && /\b(at|on|in)\b/.test(t)) {
    return "Not quite. Use 'at' for specific places/times (at home, at 5), 'on' for days/dates (on Monday), and 'in' for months/longer periods (in June, in the morning). Try the sentence again.";
  }
  if ((it.kind||it.templateType||"").toLowerCase() === "yesno") {
    return "Not quite. Use short answers correctly: Yes, he does. / No, he doesn't. Repeat the correct short answer out loud.";
  }
  return "Not quite. Check the story and try again. / –ù–µ —Ç–æ—á–Ω–æ. –í—ä—Ä–Ω–µ—Ç–µ —Å–µ –∫—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫.";
}

/* --- 2) Normalize + translit (BG->LAT) --- */
function translitBgWord(w){
  const map = {
    '–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','–∂':'zh','–∑':'z','–∏':'i','–π':'y','–∫':'k',
    '–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h',
    '—Ü':'ts','—á':'ch','—à':'sh','—â':'sht','—ä':'a','—å':'','—é':'yu','—è':'ya',
    '–ê':'a','–ë':'b','–í':'v','–ì':'g','–î':'d','–ï':'e','–ñ':'zh','–ó':'z','–ò':'i','–ô':'y','–ö':'k',
    '–õ':'l','–ú':'m','–ù':'n','–û':'o','–ü':'p','–†':'r','–°':'s','–¢':'t','–£':'u','–§':'f','–•':'h',
    '–¶':'ts','–ß':'ch','–®':'sh','–©':'sht','–™':'a','–¨':'','–Æ':'yu','–Ø':'ya'
  };
  let out = '';
  for (const ch of w) out += (map[ch] ?? ch);
  out = out.replace(/ks\b/, 'x'); // tiny fixes
  out = out.replace(/ts\b/, 'c');
  return out;
}
function normWord(s){
  return String(s||'').toLowerCase()
    .replace(/[‚Äú‚Äù"‚Äò‚Äô']/g,'"')
    .replace(/[.,!?;:()]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function normalizeForMatch(s){
  const base = normWord(s);
  if (/[–∞-—è–ê-–Ø]/.test(base)) return translitBgWord(base);
  return base;
}

/* --- 3) ASR (speech-to-text) --- */
const Recog = window.SpeechRecognition || window.webkitSpeechRecognition;
function startRecognitionFor(input, resultEl){
  if(!speechEnabled || !Recog){
    resultEl.textContent = "Speech input unavailable on this browser. / –ì–æ–≤–æ—Ä–Ω–∏—è—Ç –≤—Ö–æ–¥ –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω –≤ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä.";
    resultEl.className='muted'; return null;
  }
  stopRecognition();
  const r = new Recog();
  r.lang = 'bg-BG';
  r.interimResults = false;
  r.maxAlternatives = 1;
  input.classList.add('listening');
  resultEl.className='muted';
  resultEl.innerHTML = `Listening‚Ä¶ <span class="wave"></span>`;
  r.onresult = (e)=>{
    const heard = (e.results?.[0]?.[0]?.transcript || '').trim();
    if (heard) {
      if (/[–∞-—è–ê-–Ø]/.test(heard)) {
        const lat = translitBgWord(heard);
        input.value = lat;
        resultEl.textContent = `Heard: ‚Äú${heard}‚Äù ‚Üí ${lat}. Press Check. / –ß—É—Ç–æ: ‚Äû${heard}‚Äú ‚Üí ${lat}. –ù–∞—Ç–∏—Å–Ω–∏ Check.`;
      } else {
        input.value = heard;
        resultEl.textContent = `Heard: ‚Äú${heard}‚Äù. Press Check. / –ß—É—Ç–æ: ‚Äû${heard}‚Äú. –ù–∞—Ç–∏—Å–Ω–∏ Check.`;
      }
      if (autoCheck) {
        setTimeout(()=> {
          const btn = input.parentElement.querySelector('button[data-role="check"]');
          btn?.click();
        }, 500);
      }
    } else {
      resultEl.textContent = "I didn‚Äôt catch that. Try again. / –ù–µ —Ç–µ —á—É—Ö. –û–ø–∏—Ç–∞–π –ø–∞–∫.";
    }
  };
  r.onspeechend = ()=> r.stop();
  r.onend = ()=>{
    input.classList.remove('listening');
    if(!input.value){
      resultEl.textContent = "I didn‚Äôt catch that. Say the word clearly or type it. / –ù–µ —Ç–µ —á—É—Ö. –ö–∞–∂–∏ –¥—É–º–∞—Ç–∞ —è—Å–Ω–æ –∏–ª–∏ —è –Ω–∞–ø–∏—à–∏.";
    }
  };
  r.onerror = ()=>{
    input.classList.remove('listening');
    resultEl.textContent = "Microphone error. Check permissions. / –ü—Ä–æ–±–ª–µ–º —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ ‚Äì –ø–æ–∑–≤–æ–ª–∏ –¥–æ—Å—Ç—ä–ø.";
  };
  try{ r.start(); }catch{}
  window.__activeRecog = r;
  return r;
}
function stopRecognition(){
  const r = window.__activeRecog;
  if (r) { try{ r.stop(); }catch{} }
  window.__activeRecog = null;
}

/* --- 3b) Meta –∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ç–∞ (Speak label + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏) --- */
function getExerciseMeta(ex){
  const t = (ex.template_type || '').toLowerCase();
  let speakLabel = 'Speak your answer';
  let instruction_en = ex.instruction_en || '';
  let instruction_bg = ex.instruction_bg || '';

  if (t === 'story_fill_01') {
    speakLabel = 'Speak the words / Fill the blanks';
    if (!instruction_en) instruction_en = 'Fill in the blanks based on the story.';
    if (!instruction_bg) instruction_bg = '–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç–∏—Ç–µ –¥—É–º–∏ —Å–ø–æ—Ä–µ–¥ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.';
  } else if (t === 'story_reorder') {
    speakLabel = 'Speak the sentences / Rearrange';
    if (!instruction_en) instruction_en = 'Rearrange the sentences to match the story.';
    if (!instruction_bg) instruction_bg = '–ü–æ–¥—Ä–µ–¥–µ—Ç–µ –∏–∑—Ä–µ—á–µ–Ω–∏—è—Ç–∞ —Å–ø–æ—Ä–µ–¥ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.';
  } else if (t === 'story_short_answers') {
    speakLabel = 'Speak the short answer';
    if (!instruction_en) instruction_en = 'Answer with a short Yes/No or phrase based on the story.';
    if (!instruction_bg) instruction_bg = '–û—Ç–≥–æ–≤–æ—Ä–µ—Ç–µ —Å –∫—Ä–∞—Ç—ä–∫ –æ—Ç–≥–æ–≤–æ—Ä —Å–ø–æ—Ä–µ–¥ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.';
  } else if (t === 'story_pos_neg') {
    speakLabel = 'Speak the positive and negative sentence';
    if (!instruction_en) instruction_en = 'Say the positive and the negative form.';
    if (!instruction_bg) instruction_bg = '–ö–∞–∂–µ—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª–Ω–æ—Ç–æ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–Ω–æ—Ç–æ –∏–∑—Ä–µ—á–µ–Ω–∏–µ.';
  } else if (t === 'story_full_answers') {
    speakLabel = 'Speak the full sentence';
    if (!instruction_en) instruction_en = 'Answer with a full sentence based on the story.';
    if (!instruction_bg) instruction_bg = '–û—Ç–≥–æ–≤–æ—Ä–µ—Ç–µ —Å –ø—ä–ª–Ω–æ –∏–∑—Ä–µ—á–µ–Ω–∏–µ —Å–ø–æ—Ä–µ–¥ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.';
  }

  return { speakLabel, instruction_en, instruction_bg };
}

function inferKindFromTemplate(template_type, item){
  const t = (template_type || '').toLowerCase();
  if (t.includes('reorder')) return 'reorder';
  if (t.includes('short_answers')) {
    const a = String(item && item.a || '').trim().toLowerCase();
    if (a.startsWith('yes') || a.startsWith('no')) return 'yesno';
  }
  return 'fill';
}

/* --- 4) Story meta (—Ä–∞–∑–∫–∞–∑—á–µ—Ç–æ) ‚Äì –æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ --- */
async function loadStoryMeta(level, unit, section){
  if (section !== 'story') return null;

  const lvlUp = level.toUpperCase();
  const unitUp = unit.toUpperCase();
  const m = /^L?(\d+)/i.exec(unitUp);
  const unit2 = m ? String(m[1]).padStart(2,'0') : '01';

  const candidates = [
    // –Ω–æ–≤ author —Ñ–æ—Ä–º–∞—Ç ‚Äì –∞–∫–æ —Ä–µ—à–∏—à –¥–∞ –∫–∞—á–∏—à author.L02.story.json
    `data/${lvlUp}/story/author.${unitUp}.story.json`,
    // —Å—Ç–∞—Ä full —Ñ–æ—Ä–º–∞—Ç ‚Äì –Ω–∞–ø—Ä–∏–º–µ—Ä a1.lesson02.full.json
    `data/${lvlUp.toLowerCase()}.lesson${unit2}.full.json`
  ];

  for (const path of candidates){
    try{
      const res = await fetch(path, {cache:'no-store'});
      if (!res.ok) continue;
      const j = await res.json();
      // –≤–∞—Ä–∏–∞–Ω—Ç 1: { title, content:[] }
      if (j && typeof j.title === 'string' && Array.isArray(j.content)) {
        return { title:j.title, content:j.content };
      }
      // –≤–∞—Ä–∏–∞–Ω—Ç 2: { story:{title, content:[]} }
      if (j && j.story && typeof j.story.title === 'string' && Array.isArray(j.story.content)) {
        return { title:j.story.title, content:j.story.content };
      }
    }catch(e){
      // –∏–≥–Ω–æ—Ä–∏—Ä–∞–º–µ –∏ –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞–º–µ
    }
  }
  return null;
}

/* --- 5) Load + expand JSON to items --- */
async function loadData(level, unit, section, file, typeParam){
  // –ó–∞ A1/story –ø—Ä–æ–±–≤–∞–º–µ –ø—ä—Ä–≤–æ seed —Ñ–∞–π–ª–æ–≤–µ—Ç–µ: data/A1/story/seed.LXX.story.json
  if (!file && section === 'story') {
    const lvlUp = level.toUpperCase();
    const unitUp = unit.toUpperCase();
    file = `data/${lvlUp}/story/seed.${unitUp}.story.json`;
  }

  const res = await fetch(file, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
  const data = await res.json();

  const blocks = [];
  const defaults = data.feedbackDefaults || {};

  /* --- A) –ù–æ–≤ —Ñ–æ—Ä–º–∞—Ç: seed.LXX.story.json ‚Üí Array --- */
  if (Array.isArray(data)) {
    data.forEach((ex, exIdx) => {
      const meta = getExerciseMeta(ex);

      const block = {
        title: ex.title || `Exercise ${exIdx+1}`,
        speakLabel: meta.speakLabel,
        instruction_en: meta.instruction_en,
        instruction_bg: meta.instruction_bg,
        template_type: ex.template_type || '',
        exercise_id: ex.exercise_id || '',
        items: []
      };

      // block.sub —â–µ –ø–æ–∫–∞–∑–≤–∞ Speak + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (EN/BG)
      const subLines = [];
      if (meta.speakLabel) subLines.push(meta.speakLabel);
      const instrLine = [meta.instruction_en, meta.instruction_bg].filter(Boolean).join(' / ');
      if (instrLine) subLines.push(instrLine);
      block.sub = subLines.length ? subLines : null;

      const t = (ex.template_type || '').toLowerCase();

      if (t === 'story_reorder') {
        // –ï–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ = –µ–¥–∏–Ω Reorder –±–ª–æ–∫ —Å –∏–∑—Ä–µ—á–µ–Ω–∏—è
        block.items.push({
          kind: 'reorder',
          prompt: ex.title || '',
          sentences: Array.isArray(ex.items) ? ex.items.slice() : [],
          correct_order: Array.isArray(ex.correct_order) ? ex.correct_order.slice() : [],
          speakLabel: meta.speakLabel,
          instruction_en: meta.instruction_en,
          instruction_bg: meta.instruction_bg
        });
      } else {
        // Fill / short_answers / pos_neg / full_answers
        const arr = Array.isArray(ex.items) ? ex.items : [];
        arr.forEach(item => {
          const kind = inferKindFromTemplate(ex.template_type, item);
          block.items.push({
            kind,
            prompt: item.q || '',
            answer: item.a || '',
            speakLabel: meta.speakLabel,
            instruction_en: meta.instruction_en,
            instruction_bg: meta.instruction_bg
          });
        });
      }

      if (typeParam) {
        block.items = block.items.filter(it => {
          const k = (it.kind || '').toLowerCase();
          if (typeParam === 'fill')    return k === 'fill';
          if (typeParam === 'yesno')   return k === 'yesno';
          if (typeParam === 'reorder') return k === 'reorder';
          return true;
        });
      }

      if (block.items.length) blocks.push(block);
    });

    return { blocks, defaults };
  }

  /* --- B) –°—Ç–∞—Ä —Ñ–æ—Ä–º–∞—Ç (lessons/exercises) ‚Äì –æ—Å—Ç–∞–≤—è–º–µ –∑–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç --- */
  const lessons = data.lessons || {};
  const rawNum = String(unit).replace(/^L/i,'').replace(/^0+/, '');
  const num2   = rawNum.padStart(2,'0');
  const candidates = [unit, unit.toUpperCase(), unit.toLowerCase(), 'L'+rawNum, 'l'+rawNum, 'L'+num2, 'l'+num2];
  const key = candidates.find(k => Object.prototype.hasOwnProperty.call(lessons, k)) || null;

  const lesson   = key ? lessons[key] : null;
  if (!lesson) return {blocks:[], defaults};

  (lesson.exercises || []).forEach((ex, exIdx) => {
    const lines = (ex.payload && Array.isArray(ex.payload.lines)) ? ex.payload.lines.slice() : [];
    if (!lines.length){ return; }

    const block = { title: ex.title || `Exercise ${exIdx+1}`, sub: null, items: [] };
    const firstInfo = lines.find(s => /fill|translate|rearrange|–ø–æ–¥—Ä–µ–¥–µ—Ç–µ|–ø–æ–ø—ä–ª–Ω–µ—Ç–µ|–ø—Ä–µ–≤–µ–¥–µ—Ç–µ/i.test(s));
    if (firstInfo) block.sub = firstInfo;

    const getKind = (declared, answer) => {
      const t = (declared || '').toLowerCase();
      if (t === 'short_answer_yesno' || t === 'yesno') return 'YesNo';
      if (t === 'reorder') return 'Reorder';
      const a = String(answer || '').trim().toLowerCase();
      if (['yes','no','–¥–∞','–Ω–µ'].includes(a)) return 'YesNo';
      return 'Fill';
    };

    const ansPos = lines.findIndex(s => /^answers\s*:?/i.test(s));
    if (ansPos !== -1){
      const prompts = lines.slice(0, ansPos).filter(s => /___/.test(s));
      const answers = lines.slice(ansPos+1).map(s => s.trim()).filter(Boolean);
      const n = Math.min(prompts.length, answers.length);
      for (let i = 0; i < n; i++){
        const kind = getKind(block.type || block.templateType || (block.meta && block.meta.type), answers[i]);
        block.items.push({
          kind,
          prompt: prompts[i],
          answer: answers[i],
          explain: block.sub || '',
          feedback: (defaults && (defaults[kind] || defaults.Fill)) || undefined,
          acceptable: block.acceptable || []
        });
      }
      if (!typeParam || block.items.some(it => (it.kind||'').toLowerCase()===typeParam)) {
        blocks.push(block);
      }
      return;
    }

    for (let i = 0; i < lines.length; i++){
      const q = lines[i];
      const mQ = /^(.*\?)\s*(?:\(.*?\))?\s*$/i.exec(q);
      const next = lines[i+1] || '';
      const mA = /^\s*(?:correct\s*answer\s*:\s*)(.*)$/i.exec(next);
      if (mQ && mA){
        const kind = getKind(block.type || block.templateType || (block.meta && block.meta.type), mA[1]);
        block.items.push({
          kind,
          prompt: mQ[1],
          answer: mA[1],
          explain: block.sub || '',
          feedback: (defaults && (defaults[kind] || defaults.Fill)) || undefined,
          acceptable: block.acceptable || []
        });
        i++;
      }
    }

    if (typeParam) {
      block.items = block.items.filter(it => (it.kind||'').toLowerCase() === typeParam);
    }
    if (block.items.length){ blocks.push(block); }
  });

  if (!blocks.length){
    const flat = Array.isArray(lesson.exercises) ? lesson.exercises : [];
    blocks.push({ title: `${unit} ‚Ä¢ ${section}`, sub: null, items: flat });
  }
  return {blocks, defaults};
}

/* --- 6) Render --- */
function render(blocks, storyMeta){
  const list = document.getElementById('list');
  list.innerHTML = '';

  // –ü—ä—Ä–≤–æ ‚Äì STORY CONTENT (—Å–∞–º–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ Listen/TTS)
  if (storyMeta && storyMeta.title && Array.isArray(storyMeta.content)) {
    const card = document.createElement('div');
    card.className = 'card';
    const titleEl = document.createElement('div');
    titleEl.className = 'story-title';
    titleEl.textContent = storyMeta.title;
    card.appendChild(titleEl);
    storyMeta.content.forEach(line => {
      const p = document.createElement('div');
      p.className = 'story-paragraph';
      p.textContent = line;
      card.appendChild(p);
    });
    list.appendChild(card);
  }

  if(!blocks.length){
    const c = document.createElement('div');
    c.className = 'card';
    c.innerHTML = `<div class="prompt">No items for ${level}/${unit}/${section}.</div>
    <div class="muted">Check URL parameters or dataset.</div>`;
    list.appendChild(c);
    return;
  }

  blocks.forEach((block, bi) => {
    const head = document.createElement('div');
    head.className = 'card';
    const t = document.createElement('div');
    t.className='block-title';
    t.textContent = `${bi+1}. ${block.title}`;
    head.appendChild(t);

    if (block.sub){
      const s = document.createElement('div');
      s.className='block-sub';
      if (Array.isArray(block.sub)) {
        s.innerHTML = block.sub.filter(Boolean).join('<br/>');
      } else {
        s.textContent = block.sub;
      }
      head.appendChild(s);
    }
    list.appendChild(head);

    block.items.forEach((it, idx) => {
      const card = document.createElement('div'); card.className = 'card';

      const p = document.createElement('div'); p.className = 'prompt';
      p.textContent = `${idx+1}. ${it.prompt || ''}`;
      card.appendChild(p);

      const kind = (it.kind || it.templateType || 'Fill').toLowerCase();
      if (kind === 'reorder') {
        renderReorderCard(card, it);
      } else {
        renderStandardCard(card, it); // Fill + YesNo (—Å –±—ä—Ä–∑–∏ –±—É—Ç–æ–Ω–∏)
      }

      list.appendChild(card);
      card.tabIndex = 0;
    });
  });
}

/* --- Standard card (Fill + YesNo quick buttons) --- */
function renderStandardCard(card, it){
  const controls = document.createElement('div'); controls.className = 'controls';

  const listen = document.createElement('button'); listen.textContent = 'üîä Listen';
  const answerUI = document.createElement('input');
  answerUI.type = 'text'; answerUI.placeholder = 'Say or type your answer‚Ä¶';
  let userTyped = false;
  answerUI.addEventListener('input', ()=>{ userTyped = true; stopRecognition(); });

  const check = document.createElement('button'); check.textContent = 'Check'; check.dataset.role = 'check';
  const speakBtn = document.createElement('button'); speakBtn.textContent = 'üéôÔ∏è Speak';
  const show = document.createElement('button'); show.textContent = 'Show answer';

  let result = document.createElement('div'); result.className='muted';

  const isYesNo = ((it.kind||'').toLowerCase()==='yesno');
  let quickWrap = null;
  if (isYesNo){
    quickWrap = document.createElement('div'); quickWrap.className='yn-quick';
    const btnYes = document.createElement('button'); btnYes.textContent = 'Yes ‚úì';
    const btnNo  = document.createElement('button'); btnNo.textContent  = 'No ‚úó';
    btnYes.onclick = ()=>{ answerUI.value='Yes'; check.click(); };
    btnNo.onclick  = ()=>{ answerUI.value='No';  check.click(); };
    quickWrap.append(btnYes, btnNo);
  }

  listen.onclick = () => {
    userTyped = false;
    say(toInstructionalSpeech(it.prompt || ''), ()=>{
      if (autoMicAfterListen && !userTyped) startRecognitionFor(answerUI, result);
    });
  };
  speakBtn.onclick = ()=> startRecognitionFor(answerUI, result);

  check.onclick = () => {
    stopRecognition();

    const rawUser = (answerUI.value || '');
    const user = normalizeForMatch(rawUser);
    const gold = normalizeForMatch(it.answer || '');

    const acc = Array.isArray(it.acceptable) ? it.acceptable.map(normalizeForMatch) : [];
    let ok = Boolean(user) && (user === gold || acc.includes(user));

    let pct = 0;
    if (!ok && user && gold) {
      const u = user.split(/\s+/).filter(Boolean);
      const g = gold.split(/\s+/).filter(Boolean);
      const inter = u.filter(w => g.includes(w)).length;
      pct = Math.round((inter / Math.max(g.length, 1)) * 100);
    }

    const oldAI = card.querySelector('.ai-feedback');
    if (oldAI) oldAI.remove();

    if (ok) {
      result.textContent = 'Correct! Well done. / –í—è—Ä–Ω–æ! –ë—Ä–∞–≤–æ.';
      result.className = 'ok';
      if (ttsEnabled) say('Correct! Well done.');
    } else {
      const baseMsg = (it.feedback && (it.feedback.wrong || it.feedback.try)) 
        ? (it.feedback.wrong || it.feedback.try) 
        : smartWrongFeedback(it);

      result.textContent = pct ? `${baseMsg} (${pct}%)` : baseMsg;
      result.className = 'bad';
      if (ttsEnabled) {
        say('Not quite. Check the story and try again.');
        if (it.answer) {
          // –ø–æ –∏–∑–±–æ—Ä ‚Äì –≤—Ç–æ—Ä–æ —Å—ä–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä
          // setTimeout(()=> say(`Correct answer: ${it.answer}`), 600);
        }
      }

      if (rawUser.trim() && IS_LOCAL) {
        fetch(`${API_BASE}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: it.prompt,
            userAnswer: rawUser,
            correctAnswer: it.answer,
            kind: it.kind || 'Fill'
          })
        })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (data && data.feedback) {
            const ai = document.createElement('div');
            ai.className = 'note ai-feedback';
            ai.textContent = data.feedback;
            result.insertAdjacentElement('afterend', ai);
          }
        })
        .catch(()=>{});
      }
    }
  };

  show.onclick = () => {
    stopRecognition();
    answerUI.value = it.answer||'';
    result.textContent = `Answer: ${it.answer||''}`;
    result.className='muted';
    if (ttsEnabled && it.answer) say(`Answer: ${it.answer}`);
  };

  controls.append(listen, answerUI, check, speakBtn, show);
  if (quickWrap) controls.append(quickWrap);
  card.appendChild(controls);
  card.appendChild(result);

  card.addEventListener('keydown', (e)=>{
    if (e.key==='L' || e.key==='l'){ e.preventDefault(); listen.click(); }
    if (e.key==='S' || e.key==='s'){ e.preventDefault(); speakBtn.click(); }
    if (e.key==='Enter'){ e.preventDefault(); check.click(); }
    if (e.key==='Escape'){ e.preventDefault(); stopRecognition(); }
  });
}

/* --- Reorder card ‚Äì –∏–∑—Ä–µ—á–µ–Ω–∏—è –≤ –∫–æ–ª–æ–Ω–∞ --- */
function renderReorderCard(card, it){
  const goldSentences = Array.isArray(it.correct_order) && it.correct_order.length
    ? it.correct_order.slice()
    : (Array.isArray(it.sentences) ? it.sentences.slice() : []);

  let bankSentences = shuffleArray(goldSentences);
  let builtSentences = [];

  const wrap = document.createElement('div'); wrap.className='reorder-wrap';
  const bank = document.createElement('div'); bank.className='bank';
  const built = document.createElement('div'); built.className='built';
  const ctrls = document.createElement('div'); ctrls.className='reorder-ctrls';
  const result = document.createElement('div'); result.className='muted';

  function renderSentences(){
    bank.innerHTML = ''; built.innerHTML='';
    bankSentences.forEach((s, i)=>{
      const el = document.createElement('div');
      el.className='sentence-token';
      el.textContent = s;
      el.onclick = ()=>{ builtSentences.push(s); bankSentences.splice(i,1); renderSentences(); };
      bank.appendChild(el);
    });
    builtSentences.forEach((s, i)=>{
      const el = document.createElement('div');
      el.className='sentence-token';
      el.textContent = s;
      el.title = 'Click to move back';
      el.onclick = ()=>{ bankSentences.push(s); builtSentences.splice(i,1); renderSentences(); };
      built.appendChild(el);
    });
  }
  renderSentences();

  const listen = document.createElement('button'); listen.textContent='üîä Listen';
  listen.onclick = ()=> say(toInstructionalSpeech(it.prompt || ''), null);

  const shuffleBtn = document.createElement('button'); shuffleBtn.textContent='Shuffle';
  shuffleBtn.onclick = ()=>{
    bankSentences = shuffleArray(goldSentences);
    builtSentences = [];
    renderSentences();
    result.textContent='';
    result.className='muted';
  };

  const clearBtn = document.createElement('button'); clearBtn.textContent='Clear';
  clearBtn.onclick = ()=>{
    bankSentences = goldSentences.slice();
    builtSentences = [];
    renderSentences();
    result.textContent='';
    result.className='muted';
  };

  const checkBtn = document.createElement('button'); checkBtn.textContent='Check';
  checkBtn.onclick = ()=>{
    const gold = goldSentences;
    const user = builtSentences;
    let match = 0;
    const maxLen = Math.max(gold.length,1);
    for(let i=0;i<maxLen;i++){
      if (user[i] && gold[i] && user[i] === gold[i]) match++;
    }
    const pct = Math.round((match / maxLen) * 100);
    const ok = (match === gold.length && user.length === gold.length);

    if (ok){
      result.textContent = 'Correct! Well done. / –í—è—Ä–Ω–æ! –ë—Ä–∞–≤–æ.';
      result.className = 'ok';
      if (ttsEnabled) say('Correct! Well done.');
    } else {
      const baseMsg = 'Not quite. Arrange the sentences to match the story.';
      result.textContent = `${baseMsg} (${pct}%)`;
      result.className = 'bad';
      if (ttsEnabled) {
        say('Not quite. Try again.');
      }
    }
  };

  ctrls.append(listen, shuffleBtn, clearBtn, checkBtn);
  wrap.appendChild(bank);
  wrap.appendChild(built);
  wrap.appendChild(ctrls);
  wrap.appendChild(result);
  card.appendChild(wrap);
}

function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* --- 7) boot --- */
(async function boot(){
  try{
    const [dataRes, storyMeta] = await Promise.all([
      loadData(level, unit, section, resolvedFile, typeParam),
      loadStoryMeta(level, unit, section)
    ]);
    render(dataRes.blocks, storyMeta);
  }catch(err){
    const list = document.getElementById('list');
    list.innerHTML = `<div class="card"><div class="prompt">Error loading data.</div>
    <div class="muted">${String(err)}</div></div>`;
  }
})();
</script>
</body>
</html>
