<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RA Exercises</title>
<style>
  :root{--w:980px;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0e12;color:#e7e9ee;margin:0;padding:16px;}
  .wrap{max-width:var(--w);margin:0 auto;}
  .head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .pill{font-size:12px;background:#1a2230;border:1px solid #2b3a55;padding:6px 10px;border-radius:999px}
  h1{font-size:18px;margin:0}
  .card{background:#10161f;border:1px solid #223047;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .prompt{font-weight:600;margin-bottom:10px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{cursor:pointer;border:1px solid #314462;background:#172133;color:#e7e9ee;border-radius:10px;padding:8px 12px}
  button:hover{background:#1e2a40}
  input[type="text"]{width:100%;max-width:420px;background:#0e131b;border:1px solid #32445f;color:#fff;border-radius:10px;padding:8px 10px}
  .ok{color:#6ee7a8}
  .bad{color:#fca5a5}
  .muted{color:#9aa7bd;font-size:13px}
  .hr{height:1px;background:#1f2a3d;margin:18px 0}
  .foot{display:flex;gap:8px;align-items:center;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <h1>Interactive Exercises</h1>
    <div class="pill" id="meta"></div>
  </div>

  <div id="list"></div>

  <div class="hr"></div>
  <div class="foot muted">Tip: Use the üîä button to hear the sentence. Your answers are checked locally.</div>
</div>

<script>
/* --- 0) URL params --- */
const url = new URL(location.href);
const level   = url.searchParams.get('level')   || 'A1';
const unit    = url.searchParams.get('unit')    || 'L2';
const section = url.searchParams.get('section') || 'grammar';
document.getElementById('meta').textContent = `${level} ‚Ä¢ ${unit} ‚Ä¢ ${section}`;

/* --- 1) TTS helpers --- */
function normalizeForSpeech(t){
  return String(t)
    .replace(/\([^)]*\)/g, ' ')
    .replace(/‚Üí/g, ' to ')
    .replace(/[‚Ä¢‚óÜ‚ó¶‚ñ†\-‚Äì‚Äî]/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .trim();
}
function toInstructionalSpeech(prompt){
  const hasBlank = /_{1,}/.test(prompt||'');
  const clean = normalizeForSpeech(prompt||'');
  if (hasBlank) return "Complete the sentence: " + clean.replace(/_{1,}/g, " ‚Ä¶ ");
  return clean;
}
let preferredVoice = null;
function pickMaleVoice(){
  const voices = window.speechSynthesis.getVoices?.() || [];
  const byMaleName = voices.find(v => /(male|david|george|guy|daniel|microsoft|google uk english male)/i.test(v.name));
  const byLangEN   = voices.find(v => /^en(-|_)/i.test(v.lang));
  preferredVoice = byMaleName || byLangEN || voices[0] || null;
}
window.speechSynthesis.onvoiceschanged = pickMaleVoice; pickMaleVoice();
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(normalizeForSpeech(text));
    if (preferredVoice) u.voice = preferredVoice;
    u.rate = 1.0; u.pitch = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch{}
}

/* --- 1a) Smart feedback --- */
function smartWrongFeedback(it){
  const t = (it.prompt || "").toLowerCase();
  if (/\bhave\b|\bhas\b|have\/has/.test(t)) {
    return "Not quite. With 'I, you, we, they' use 'have'; with 'he, she, it' use 'has'. Try repeating the sentence out loud.";
  }
  if (t.includes("plural") || /boxes|buses|churches|tomatoes|classes|wishes/.test(t)) {
    return "Not quite. For nouns ending in -x, -s, -sh, -ch, or -o, add '-es'. Say the plural form out loud.";
  }
  if (/_+/.test(it.prompt || "") && /\b(at|on|in)\b/.test(t)) {
    return "Not quite. Use 'at' for specific places/times (at home, at 5), 'on' for days/dates (on Monday), and 'in' for months/longer periods (in June, in the morning). Try the sentence again.";
  }
  if ((it.kind||it.templateType||"").toLowerCase() === "yesno") {
    return "Not quite. Use short answers correctly: Yes, he does. / No, he doesn't. Repeat the correct short answer out loud.";
  }
  return "Not quite. Re-check the rule and try again. Say the correct sentence out loud.";
}

/* --- 2) Load + normalize from JSON (v2) --- */
async function loadData(level, unit, section){
  const file = section === 'grammar' ? 'data/a1_grammar.json' : 'data/a1.json';
  const res = await fetch(file, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
  const data = await res.json();

  // 1) lessons (–≤ —Ç–≤–æ—è JSON –µ data.lessons)
  const lessons = data.lessons || data[level] || {};

  // 2) –Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞–Ω –∫–ª—é—á: L2 ‚Üí l02/L02/l2...
  const uRaw = String(unit);
  const n = (uRaw.match(/\d+/) || [''])[0];
  const candidates = [
    uRaw, uRaw.toUpperCase(), uRaw.toLowerCase(),
    'L'+n, 'l'+n,
    'L'+n.padStart(2,'0'), 'l'+n.padStart(2,'0')
  ];
  let lesson = null;
  for (const k of candidates){ if (lessons[k]) { lesson = lessons[k]; break; } }

  const exs = Array.isArray(lesson?.exercises) ? lesson.exercises : [];
  const defaults = data.feedbackDefaults || {};

  // 3) —Ä–∞–∑–≥—ä–≤–∞–º–µ payload.lines ‚Üí {kind,prompt,answer,explain,feedback}
  const items = [];
  exs.forEach(ex => {
    const lines = Array.isArray(ex.payload?.lines) ? ex.payload.lines : [];

    for (let i = 0; i < lines.length; i++){
      const cur = String(lines[i] ?? '');
      const nxt = String(lines[i+1] ?? '');

      // A) –≤—ä–ø—Ä–æ—Å + Answer: –≤ –µ–¥–∏–Ω —Ä–µ–¥
      if (/Answer\s*:/i.test(cur)){
        const [qRaw, aRaw] = cur.split(/Answer\s*:\s*/i);
        let prompt = (qRaw || '').trim();
        let answer = (aRaw || '').trim();
        if (!prompt && i>0) prompt = String(lines[i-1]||'').trim();
        if (!prompt || !answer) continue;

        const yesNo = /^(yes|no)\b/i.test(answer);
        items.push( yesNo ? {
          kind: 'YesNo',
          prompt: prompt.replace(/^\d+\.\s*/, ''),
          answer: /^yes/i.test(answer) ? 'Yes' : 'No',
          explain: answer,
          feedback: ex.feedback || defaults.YesNo
        } : {
          kind: 'Fill',
          prompt: prompt.replace(/^\d+\.\s*/, '').replace(/_{2,}/g,'____'),
          answer: answer.replace(/\.$/,'').trim(),
          explain: ex.title || '',
          feedback: ex.feedback || defaults.Fill
        });
        continue;
      }

      // B) –≤—ä–ø—Ä–æ—Å –Ω–∞ —Ç–æ–∑–∏ —Ä–µ–¥, –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ —Å–ª–µ–¥–≤–∞—â–∏—è
      if (/Answer\s*:/i.test(nxt) && !/Answer\s*:/i.test(cur)){
        const answer = nxt.split(/Answer\s*:\s*/i)[1]?.trim();
        const prompt = cur.trim();
        if (!prompt || !answer) continue;

        const yesNo = /^(yes|no)\b/i.test(answer);
        items.push( yesNo ? {
          kind: 'YesNo',
          prompt: prompt.replace(/^\d+\.\s*/, ''),
          answer: /^yes/i.test(answer) ? 'Yes' : 'No',
          explain: answer,
          feedback: ex.feedback || defaults.YesNo
        } : {
          kind: 'Fill',
          prompt: prompt.replace(/^\d+\.\s*/, '').replace(/_{2,}/g,'____'),
          answer: answer.replace(/\.$/,'').trim(),
          explain: ex.title || '',
          feedback: ex.feedback || defaults.Fill
        });
      }
    }
  });

  return items;
}

/* --- 3) Render --- */
function renderItems(items){
  const list = document.getElementById('list');

  if(!items.length){
    list.innerHTML = `<div class="card"><div class="prompt">No items for ${level}/${unit}/${section}.</div>
    <div class="muted">Check URL parameters or dataset.</div></div>`;
    return;
  }

  list.innerHTML = '';

  items.forEach((it, idx) => {
    const card = document.createElement('div'); card.className = 'card';

    const p = document.createElement('div'); p.className = 'prompt';
    p.textContent = `${idx+1}. ${it.prompt || ''}`;
    card.appendChild(p);

    const controls = document.createElement('div'); controls.className = 'controls';

    // üîä Listen
    const listen = document.createElement('button');
    listen.textContent = 'üîä Listen';
    listen.onclick = () => speak(toInstructionalSpeech(it.prompt || ''));
    controls.appendChild(listen);

    let result = document.createElement('div'); result.className='muted';

    const kind = (it.kind || it.templateType || '').toLowerCase();

    if(kind === 'fill'){
      const answerUI = document.createElement('input');
      answerUI.type = 'text'; answerUI.placeholder = 'Type your answer‚Ä¶';

      const check = document.createElement('button'); check.textContent = 'Check';
      check.onclick = () => {
        const val = (answerUI.value||'').trim().toLowerCase();
        const ok = val === String(it.answer||'').trim().toLowerCase();
        if (ok){
          result.textContent = 'Correct!';
          result.className = 'ok';
          speak('Correct! Well done.');
        } else {
          const msg = (it.feedback && it.feedback.wrong) ? it.feedback.wrong : smartWrongFeedback(it);
          result.textContent = msg;
          result.className = 'bad';
          speak(msg);
          if (it.feedback && it.feedback.readCorrectAloud && it.explain){
            speak(it.explain);
          }
        }
      };
      controls.append(answerUI, check);

      const show = document.createElement('button'); show.textContent = 'Show answer';
      show.onclick = () => { answerUI.value = it.answer||''; result.textContent = it.explain||''; result.className='muted'; };
      controls.appendChild(show);

    } else if(kind === 'yesno'){
      const yes = document.createElement('button'); yes.textContent = 'Yes';
      const no  = document.createElement('button'); no.textContent  = 'No';

      const checkYN = (val)=>{
        const ok = String(val).toLowerCase() === String(it.answer||'').toLowerCase();
        if (ok){
          result.textContent = 'Correct!';
          result.className = 'ok';
          speak('Correct! Well done.');
        } else {
          const msg = (it.feedback && it.feedback.wrong) ? it.feedback.wrong : smartWrongFeedback(it);
          result.textContent = msg;
          result.className = 'bad';
          speak(msg);
          if (it.feedback && it.feedback.readCorrectAloud && it.explain){
            speak(it.explain);
          }
        }
      };
      yes.onclick = ()=>checkYN('Yes'); no.onclick = ()=>checkYN('No');
      controls.append(yes,no);

      const explain = document.createElement('button'); explain.textContent='Explain';
      explain.onclick = ()=>{ result.textContent = it.explain||''; result.className='muted'; };
      controls.appendChild(explain);
    }

    card.appendChild(controls);
    card.appendChild(result);
    list.appendChild(card);
  });
}

// —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ
loadData(level, unit, section)
  .then(items => renderItems(items))
  .catch(err => {
    const list = document.getElementById('list');
    list.innerHTML = `<div class="card"><div class="prompt">Error loading data.</div>
    <div class="muted">${String(err)}</div></div>`;
  });
</script>
</body>
</html>
