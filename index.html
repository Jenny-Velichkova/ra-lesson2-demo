<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RA Exercises</title>
<style>
  :root{--w:980px;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0e12;color:#e7e9ee;margin:0;padding:16px;}
  .wrap{max-width:var(--w);margin:0 auto;}
  .head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .pills{display:flex;gap:6px;flex-wrap:wrap}
  .pill{font-size:12px;background:#1a2230;border:1px solid #2b3a55;padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none}
  .pill[aria-pressed="true"]{background:#142034;border-color:#3b5a8f}
  h1{font-size:18px;margin:0}
  .card{background:#10161f;border:1px solid #223047;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .block-title{font-weight:700;margin:0 0 6px 0}
  .block-sub{color:#9aa7bd;font-size:13px;margin-bottom:10px}
  .prompt{font-weight:600;margin-bottom:10px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  button{cursor:pointer;border:1px solid #314462;background:#172133;color:#e7e9ee;border-radius:10px;padding:8px 12px}
  button:hover{background:#1e2a40}
  input[type="text"]{width:100%;max-width:420px;background:#0e131b;border:1px solid #32445f;color:#fff;border-radius:10px;padding:8px 10px}
  .ok{color:#6ee7a8}
  .bad{color:#fca5a5}
  .muted{color:#9aa7bd;font-size:13px}
  .note{font-size:13px;color:#c9d6f2}
  .hr{height:1px;background:#1f2a3d;margin:18px 0}
  .foot{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .listening{border-color:#3a7bd5; box-shadow:0 0 0 2px rgba(58,123,213,.15) inset}
  .wave{width:10px;height:10px;border-radius:999px;background:#4da3ff;display:inline-block;animation:pulse 1.2s infinite ease-in-out;margin-left:6px}
  @keyframes pulse{0%{transform:scale(.9);opacity:.6}50%{transform:scale(1.2);opacity:1}100%{transform:scale(.9);opacity:.6}}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #2a3b57;padding:0 6px;border-radius:6px;font-size:.9em}
  .banner{background:#161f2c;border:1px solid #2b3b57;color:#cfe2ff;border-radius:12px;padding:10px 12px;margin-top:8px}
  .banner a{color:#82b5ff;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <h1>Interactive Exercises</h1>
    <div class="pills">
      <div class="pill" id="meta"></div>
      <div class="pill" id="pillMic" aria-pressed="false" title="Microphone permission status">Mic: OFF</div>
      <div class="pill" id="pillSpeech" aria-pressed="true">Speech: ON</div>
      <div class="pill" id="pillTTS" aria-pressed="true">TTS: ON</div>
      <div class="pill" id="pillAutoCheck" aria-pressed="false" title="Auto-check after speech">Auto-check: OFF</div>
      <div class="pill" id="pillAutoMic" aria-pressed="true" title="Auto mic after Listen">Auto-mic: ON</div>
    </div>
  </div>

  <div id="micBanner" class="banner" style="display:none"></div>

  <div class="card note" id="howto">
    <strong>–ö–∞–∫ –¥–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏—à / How to answer:</strong><br/>
    –ù–∞—Ç–∏—Å–Ω–∏ <span class="kbd">Listen</span> –∏ —Å–ª–µ–¥ –∫–∞—Ç–æ —á—É–µ—à –∏–∑—Ä–µ—á–µ–Ω–∏–µ—Ç–æ, –∫–∞–∂–∏ –ª–∏–ø—Å–≤–∞—â–∞—Ç–∞ –¥—É–º–∞. –î—É–º–∞—Ç–∞ —â–µ —Å–µ –∏–∑–ø–∏—à–µ –≤ –ø–æ–ª–µ—Ç–æ ‚Äì –º–æ–∂–µ—à –¥–∞ —è —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞—à, –ø–æ—Å–ª–µ –Ω–∞—Ç–∏—Å–Ω–∏ <span class="kbd">Check</span>.<br/>
    If you prefer typing, just write the word instead. <span class="kbd">L</span>=Listen, <span class="kbd">S</span>=Speak, <span class="kbd">Enter</span>=Check, <span class="kbd">Esc</span>=Stop.
  </div>

  <div id="list"></div>

  <div class="hr"></div>
  <div class="foot muted">Tip: Use the üîä button to hear the sentence. Your answers are checked locally.</div>
</div>

<script>
/* --- 0) URL params --- */
const url = new URL(location.href);
const level   = (url.searchParams.get('level')   || 'A1').toUpperCase();
const unit    = (url.searchParams.get('unit')    || 'L2').toUpperCase();
const section = (url.searchParams.get('section') || 'story').toLowerCase();
document.getElementById('meta').textContent = `${level} ‚Ä¢ ${unit} ‚Ä¢ ${section}`;

/* --- Browser helpers --- */
const ua = navigator.userAgent || '';
function detectBrowser(){
  if (/Edg\//.test(ua)) return 'edge';
  if (/Chrome\//.test(ua) && !/Edg\//.test(ua)) return 'chrome';
  if (/Firefox\//.test(ua)) return 'firefox';
  if (/Safari\//.test(ua) && !/Chrome\//.test(ua)) return 'safari';
  return 'other';
}
function micHelpURL(){
  const b = detectBrowser();
  if (b==='chrome')  return 'chrome://settings/content/microphone';
  if (b==='edge')    return 'edge://settings/content/microphone';
  if (b==='firefox') return 'about:preferences#privacy';
  if (b==='safari')  return 'https://support.apple.com/guide/safari/change-websites-settings-ibrw7c0ba8fe/mac';
  return 'https://support.google.com/chrome/answer/2693767';
}

/* --- Global toggles (with localStorage) --- */
const store = {
  get(k, def){ try{ const v=localStorage.getItem(k); return v===null?def:JSON.parse(v);}catch{ return def; } },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
};
let speechEnabled   = store.get('speechEnabled', true);
let ttsEnabled      = store.get('ttsEnabled', true);
let autoCheck       = store.get('autoCheck', false);
let autoMicAfterListen = store.get('autoMicAfterListen', true);
function syncPills(){
  const pS = document.getElementById('pillSpeech');
  const pT = document.getElementById('pillTTS');
  const pA = document.getElementById('pillAutoCheck');
  const pM = document.getElementById('pillAutoMic');
  pS.setAttribute('aria-pressed', String(speechEnabled)); pS.textContent = `Speech: ${speechEnabled?'ON':'OFF'}`;
  pT.setAttribute('aria-pressed', String(ttsEnabled));    pT.textContent = `TTS: ${ttsEnabled?'ON':'OFF'}`;
  pA.setAttribute('aria-pressed', String(autoCheck));     pA.textContent = `Auto-check: ${autoCheck?'ON':'OFF'}`;
  pM.setAttribute('aria-pressed', String(autoMicAfterListen)); pM.textContent = `Auto-mic: ${autoMicAfterListen?'ON':'OFF'}`;
}
document.getElementById('pillSpeech').onclick   = ()=>{ speechEnabled=!speechEnabled; store.set('speechEnabled', speechEnabled); syncPills(); };
document.getElementById('pillTTS').onclick      = ()=>{ ttsEnabled=!ttsEnabled; store.set('ttsEnabled', ttsEnabled); syncPills(); };
document.getElementById('pillAutoCheck').onclick= ()=>{ autoCheck=!autoCheck; store.set('autoCheck', autoCheck); syncPills(); };
document.getElementById('pillAutoMic').onclick  = ()=>{ autoMicAfterListen=!autoMicAfterListen; store.set('autoMicAfterListen', autoMicAfterListen); syncPills(); };
syncPills();

/* --- 1) TTS helpers --- */
function normalizeForSpeech(t){
  return String(t).replace(/\([^)]*\)/g,' ').replace(/‚Üí/g,' to ').replace(/[‚Ä¢‚óÜ‚ó¶‚ñ†\-‚Äì‚Äî]/g,' ').replace(/\s{2,}/g,' ').trim();
}
function toInstructionalSpeech(prompt){
  const hasBlank = /_{1,}/.test(prompt||''); const clean = normalizeForSpeech(prompt||'');
  if (hasBlank) return "Complete the sentence: " + clean.replace(/_{1,}/g, " ‚Ä¶ ");
  return clean;
}
let preferredVoice = null;
function pickMaleVoice(){
  const voices = window.speechSynthesis.getVoices?.() || [];
  const byMaleName = voices.find(v => /(male|david|george|guy|daniel|microsoft|google uk english male)/i.test(v.name));
  const byLangEN   = voices.find(v => /^en(-|_)/i.test(v.lang));
  preferredVoice = byMaleName || byLangEN || voices[0] || null;
}
window.speechSynthesis.onvoiceschanged = pickMaleVoice; pickMaleVoice();
function say(text, onend){
  if(!ttsEnabled) { onend && setTimeout(onend, 400); return; }
  try{
    const u = new SpeechSynthesisUtterance(normalizeForSpeech(text));
    if (preferredVoice) u.voice = preferredVoice;
    u.rate = 1.0; u.pitch = 1.0;
    if (onend) u.onend = onend;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch{ onend && setTimeout(onend, 400); }
}

/* --- 1a) Smart feedback --- */
function smartWrongFeedback(it){
  const t = (it.prompt || "").toLowerCase();
  if (/\bhave\b|\bhas\b|have\/has/.test(t)) return "Not quite. With 'I, you, we, they' use 'have'; with 'he, she, it' use 'has'. Try repeating the sentence out loud.";
  if (t.includes("plural") || /boxes|buses|churches|tomatoes|classes|wishes/.test(t)) return "Not quite. For nouns ending in -x, -s, -sh, -ch, or -o, add '-es'. Say the plural form out loud.";
  if (/_+/.test(it.prompt || "") && /\b(at|on|in)\b/.test(t)) return "Not quite. Use 'at' for specific places/times (at home, at 5), 'on' for days/dates (on Monday), and 'in' for months/longer periods (in June, in the morning). Try the sentence again.";
  if ((it.kind||it.templateType||"").toLowerCase() === "yesno") return "Not quite. Use short answers correctly: Yes, he does. / No, he doesn't. Repeat the correct short answer out loud.";
  return "Not quite. Check the story and try again. / –ù–µ —Ç–æ—á–Ω–æ. –í—ä—Ä–Ω–µ—Ç–µ —Å–µ –∫—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫.";
}

/* --- 2) Helpers: normalize answers --- */
function norm(s){
  return String(s||'').toLowerCase().replace(/[‚Äú‚Äù"‚Äò‚Äô']/g,'"').replace(/[.,!?;:()]/g,' ').replace(/\s+/g,' ').trim();
}

/* --- 3) Mic permission & ASR helpers --- */
const Recog = window.SpeechRecognition || window.webkitSpeechRecognition;

async function getMicPermissionState(){
  // default: unknown
  let state = 'unknown';
  if (navigator.permissions?.query){
    try{
      const st = await navigator.permissions.query({ name: 'microphone' });
      state = st.state; // 'granted' | 'denied' | 'prompt'
      st.onchange = ()=>updateMicUI(st.state);
    }catch{}
  }
  return state;
}

function updateMicUI(state){
  const pill = document.getElementById('pillMic');
  const banner = document.getElementById('micBanner');
  const help = micHelpURL();

  if (state==='granted'){
    pill.setAttribute('aria-pressed','true');
    pill.textContent = 'Mic: ON';
    pill.title = 'Microphone allowed';
    banner.style.display = 'none';
  } else {
    pill.setAttribute('aria-pressed','false');
    pill.textContent = 'Mic: OFF';
    const b = detectBrowser();
    const msgUnavailable = (!Recog)
      ? `–ì–ª–∞—Å–æ–≤–∏—è—Ç –≤—Ö–æ–¥ –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω –≤ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ Chrome –∏–ª–∏ Edge.
         / Speech input is unavailable in this browser. Please use Chrome or Edge.`
      : `–ú–∏–∫—Ä–æ—Ñ–æ–Ω—ä—Ç –µ –∏–∑–∫–ª—é—á–µ–Ω –∏–ª–∏ –±–ª–æ–∫–∏—Ä–∞–Ω. –†–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –∏ –ø—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.
         / Microphone is off or blocked. Allow access and reload.`;

    pill.title = 'Click to request mic access';
    banner.innerHTML = `
      <strong>Microphone help</strong> ‚Ä¢ ${msgUnavailable}
      <br/>Open settings: <a href="${help}" target="_blank" rel="noopener">mic settings</a>
      &nbsp;|&nbsp; <button id="btnAskMic" style="margin-left:4px">Enable mic</button>
    `;
    banner.style.display = 'block';
    const btn = document.getElementById('btnAskMic');
    if (btn){
      btn.onclick = async ()=>{
        try{
          const s = await navigator.mediaDevices.getUserMedia({ audio: true });
          s.getTracks().forEach(t=>t.stop());
          updateMicUI('granted');
        }catch{
          updateMicUI('denied');
        }
      };
    }
  }
}

async function initMicUI(){
  const state = await getMicPermissionState();
  updateMicUI(state);
  document.getElementById('pillMic').onclick = async ()=>{
    try{
      const s = await navigator.mediaDevices.getUserMedia({ audio: true });
      s.getTracks().forEach(t=>t.stop());
      updateMicUI('granted');
    }catch{
      updateMicUI('denied');
    }
  };
}
initMicUI();

function startRecognitionFor(input, resultEl){
  if(!speechEnabled){
    resultEl.textContent = "Speech input is turned off. / –ì–ª–∞—Å–æ–≤–∏—è—Ç –≤—Ö–æ–¥ –µ –∏–∑–∫–ª—é—á–µ–Ω.";
    resultEl.className='muted'; return null;
  }
  if(!Recog){
    resultEl.textContent = "Speech input unavailable on this browser. Try Chrome or Edge. / –ì–ª–∞—Å–æ–≤–∏—è—Ç –≤—Ö–æ–¥ –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω –≤ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ Chrome –∏–ª–∏ Edge.";
    resultEl.className='muted'; return null;
  }
  stopRecognition();
  const r = new Recog();
  // Fallback –∫—ä–º en-US, –Ω–æ —â–µ –ø—Ä–∏–µ–º–∞–º–µ ‚Äû–±–æ–∫—Å‚Äú –∫–∞—Ç–æ box (–≤–∏–∂ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –æ—Ç –ø–æ-—Ä–∞–Ω–æ)
  r.lang = 'bg-BG';
  r.interimResults = false;
  r.maxAlternatives = 1;

  input.classList.add('listening');
  resultEl.className='muted';
  resultEl.innerHTML = `Listening‚Ä¶ <span class="wave"></span>`;

  r.onresult = (e)=>{
    const raw = (e.results?.[0]?.[0]?.transcript || '').trim();
    const heard = raw || '';
    if (heard) {
      // –ø–æ–∫–∞–∑–≤–∞–º–µ —á—É—Ç–æ—Ç–æ; –Ω–µ –ø–∏–ø–∞–º–µ —Ç—É–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è—Ç–∞, —Å–∞–º–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
      input.value = heard;
      resultEl.textContent = `Heard: ‚Äú${heard}‚Äù. Press Check. / –ß—É—Ç–æ: ‚Äû${heard}‚Äú. –ù–∞—Ç–∏—Å–Ω–∏ Check.`;
      if (autoCheck) {
        setTimeout(()=> {
          const btn = input.parentElement.querySelector('button[data-role="check"]');
          btn?.click();
        }, 400);
      }
    } else {
      resultEl.textContent = "I didn‚Äôt catch that. Say the word clearly or type it. / –ù–µ —Ç–µ —á—É—Ö. –ö–∞–∂–∏ –¥—É–º–∞—Ç–∞ —è—Å–Ω–æ –∏–ª–∏ —è –Ω–∞–ø–∏—à–∏.";
    }
  };
  r.onspeechend = ()=> r.stop();
  r.onend = ()=>{
    input.classList.remove('listening');
    if(!input.value){
      resultEl.textContent = "I didn‚Äôt catch that. Say the word clearly or type it. / –ù–µ —Ç–µ —á—É—Ö. –ö–∞–∂–∏ –¥—É–º–∞—Ç–∞ —è—Å–Ω–æ –∏–ª–∏ —è –Ω–∞–ø–∏—à–∏.";
    }
  };
  r.onerror = ()=>{
    input.classList.remove('listening');
    resultEl.textContent = "Microphone error. Check permissions. / –ü—Ä–æ–±–ª–µ–º —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ ‚Äì –ø–æ–∑–≤–æ–ª–∏ –¥–æ—Å—Ç—ä–ø.";
  };
  try{ r.start(); }catch{}
  window.__activeRecog = r;
  return r;
}
function stopRecognition(){
  const r = window.__activeRecog;
  if (r) { try{ r.stop(); }catch{} }
  window.__activeRecog = null;
}

/* --- 4) Load + expand JSON to items --- */
async function loadData(level, unit, section){
  const file = section === 'grammar' ? 'data/a1_grammar.json' : 'data/a1.json';
  const res = await fetch(file, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
  const data = await res.json();

  const lessons = data.lessons || {};
  const rawNum = String(unit).replace(/^L/i,'').replace(/^0+/,'');
  const num2   = rawNum.padStart(2,'0');
  const candidates = [unit, unit.toUpperCase(), unit.toLowerCase(), 'L'+rawNum, 'l'+rawNum, 'L'+num2, 'l'+num2];
  const key = candidates.find(k => Object.prototype.hasOwnProperty.call(lessons, k)) || null;

  const lesson   = key ? lessons[key] : null;
  if (!lesson) return {blocks:[], defaults:data.feedbackDefaults||{}};

  const blocks = [];
  const defaults = data.feedbackDefaults || {};

  (lesson.exercises || []).forEach((ex, exIdx) => {
    const lines = (ex.payload && Array.isArray(ex.payload.lines)) ? ex.payload.lines.slice() : [];
    if (!lines.length){ return; }

    const block = { title: ex.title || `Exercise ${exIdx+1}`, sub: null, items: [] };
    const firstInfo = lines.find(s => /fill|translate|rearrange|–ø–æ–¥—Ä–µ–¥–µ—Ç–µ|–ø–æ–ø—ä–ª–Ω–µ—Ç–µ|–ø—Ä–µ–≤–µ–¥–µ—Ç–µ/i.test(s));
    if (firstInfo) block.sub = firstInfo;

    const ansPos = lines.findIndex(s => /^answers\s*:?/i.test(s));
    if (ansPos !== -1){
      const prompts = lines.slice(0, ansPos).filter(s => /___/.test(s));
      const answers = lines.slice(ansPos+1).map(s => s.trim()).filter(Boolean);
      const n = Math.min(prompts.length, answers.length);
      for(let i=0;i<n;i++){
        block.items.push({ kind:'Fill', prompt: prompts[i], answer: answers[i], explain: block.sub || '', feedback: defaults.Fill || undefined });
      }
      blocks.push(block); return;
    }
    for(let i=0;i<lines.length;i++){
      const q = lines[i];
      const mQ = /^(.*\?)\s*(?:\(.*?\))?\s*$/i.exec(q);
      const next = lines[i+1] || '';
      const mA = /^\s*(?:correct\s*answer\s*:\s*)(.*)$/i.exec(next);
      if (mQ && mA){
        block.items.push({ kind:'Fill', prompt: mQ[1], answer: mA[1], explain: block.sub || '', feedback: defaults.Fill || undefined });
        i++;
      }
    }
    if (block.items.length){ blocks.push(block); }
  });

  if (!blocks.length){
    const flat = Array.isArray(lesson.exercises) ? lesson.exercises : [];
    blocks.push({ title: `${unit} ‚Ä¢ ${section}`, sub: null, items: flat });
  }
  return {blocks, defaults};
}

/* --- 5) Render --- */
function render(blocks){
  const list = document.getElementById('list');
  list.innerHTML = '';

  if(!blocks.length){
    list.innerHTML = `<div class="card"><div class="prompt">No items for ${level}/${unit}/${section}.</div>
    <div class="muted">Check URL parameters or dataset.</div></div>`;
    return;
  }

  blocks.forEach((block, bi) => {
    const head = document.createElement('div');
    head.className = 'card';
    const t = document.createElement('div'); t.className='block-title'; t.textContent = `${bi+1}. ${block.title}`;
    head.appendChild(t);
    if (block.sub){
      const s = document.createElement('div'); s.className='block-sub'; s.textContent = block.sub;
      head.appendChild(s);
    }
    list.appendChild(head);

    block.items.forEach((it, idx) => {
      const card = document.createElement('div'); card.className = 'card';

      const p = document.createElement('div'); p.className = 'prompt';
      p.textContent = `${idx+1}. ${it.prompt || ''}`;
      card.appendChild(p);

      const controls = document.createElement('div'); controls.className = 'controls';

      const listen = document.createElement('button');
      listen.textContent = 'üîä Listen';

      const answerUI = document.createElement('input');
      answerUI.type = 'text'; answerUI.placeholder = 'Say or type your answer‚Ä¶';
      let userTyped = false;
      answerUI.addEventListener('input', ()=>{ userTyped = true; stopRecognition(); });

      const check = document.createElement('button'); check.textContent = 'Check'; check.dataset.role = 'check';
      const speakBtn = document.createElement('button'); speakBtn.textContent = 'üéôÔ∏è Speak';
      const show = document.createElement('button'); show.textContent = 'Show answer';

      let result = document.createElement('div'); result.className='muted';

      listen.onclick = () => {
        userTyped = false;
        say(toInstructionalSpeech(it.prompt || ''), ()=>{
          if (autoMicAfterListen && !userTyped) startRecognitionFor(answerUI, result);
        });
      };
      speakBtn.onclick = ()=> startRecognitionFor(answerUI, result);

      check.onclick = () => {
        stopRecognition();
        const user = norm(answerUI.value||'');
        const gold = norm(it.answer||'');
        const ok = user && gold && user === gold;
        if (ok){
          result.textContent = 'Correct! Well done. / –í—è—Ä–Ω–æ! –ë—Ä–∞–≤–æ.';
          result.className = 'ok';
          if (ttsEnabled) say('Correct! Well done.');
        } else {
          const msg = (it.feedback && it.feedback.wrong) ? it.feedback.wrong : smartWrongFeedback(it);
          result.textContent = msg;
          result.className = 'bad';
          if (ttsEnabled) say('Not quite. Check the story and try again.');
        }
      };

      show.onclick = () => {
        stopRecognition();
        answerUI.value = it.answer||'';
        result.textContent = `Answer: ${it.answer||''}`;
        result.className='muted';
        if (ttsEnabled && it.answer) say(`Answer: ${it.answer}`);
      };

      controls.append(listen, answerUI, check, speakBtn, show);
      card.appendChild(controls);
      card.appendChild(result);
      list.appendChild(card);

      // keyboard shortcuts
      card.addEventListener('keydown', (e)=>{
        if (e.key==='L' || e.key==='l'){ e.preventDefault(); listen.click(); }
        if (e.key==='S' || e.key==='s'){ e.preventDefault(); speakBtn.click(); }
        if (e.key==='Enter'){ e.preventDefault(); check.click(); }
        if (e.key==='Escape'){ e.preventDefault(); stopRecognition(); }
      });
      card.tabIndex = 0;
    });
  });
}

/* --- 6) boot --- */
loadData(level, unit, section)
  .then(({blocks}) => render(blocks))
  .catch(err => {
    const list = document.getElementById('list');
    list.innerHTML = `<div class="card"><div class="prompt">Error loading data.</div>
    <div class="muted">${String(err)}</div></div>`;
  });
</script>
</body>
</html>
