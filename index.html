<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RA Exercises</title>
<style>
  :root{--w:980px;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0e12;color:#e7e9ee;margin:0;padding:16px;}
  .wrap{max-width:var(--w);margin:0 auto;}
  .head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .pill{font-size:12px;background:#1a2230;border:1px solid #2b3a55;padding:6px 10px;border-radius:999px;user-select:none}
  .pill.toggle{cursor:pointer}
  h1{font-size:18px;margin:0}
  .card{background:#10161f;border:1px solid #223047;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .block-title{font-weight:700;margin:0 0 6px 0}
  .block-sub{color:#9aa7bd;font-size:13px;margin-bottom:10px}
  .prompt{font-weight:600;margin-bottom:10px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{cursor:pointer;border:1px solid #314462;background:#172133;color:#e7e9ee;border-radius:10px;padding:8px 12px}
  button:hover{background:#1e2a40}
  input[type="text"]{width:100%;max-width:420px;background:#0e131b;border:1px solid #32445f;color:#fff;border-radius:10px;padding:8px 10px}
  .ok{color:#6ee7a8}
  .bad{color:#fca5a5}
  .muted{color:#9aa7bd;font-size:13px}
  .hr{height:1px;background:#1f2a3d;margin:18px 0}
  .foot{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .notice{font-size:13px;color:#eab308}
  .caption{font-size:12px;color:#9aa7bd;margin-top:4px}
  .instructions{background:#0f1420;border:1px dashed #314462;padding:10px;border-radius:12px;margin-top:8px;color:#c6d3eb;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <h1>Interactive Exercises</h1>
    <div class="status">
      <div class="pill" id="meta"></div>
      <div class="pill toggle" id="pillSpeech" title="Toggle microphone">Speech: ON</div>
      <div class="pill toggle" id="pillTTS" title="Toggle text-to-speech">TTS: ON</div>
    </div>
  </div>

  <div class="instructions">
    <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong> üéß –ò–∑—Å–ª—É—à–∞–π—Ç–µ –∏–∑—Ä–µ—á–µ–Ω–∏–µ—Ç–æ. üéôÔ∏è –ü—Ä–æ–∏–∑–Ω–µ—Å–µ—Ç–µ –ª–∏–ø—Å–≤–∞—â–∞—Ç–∞ –¥—É–º–∞ –∏–ª–∏ —è –Ω–∞–ø–∏—à–µ—Ç–µ.
    ‚úÖ –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ ‚ÄûCheck‚Äú, –∑–∞ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç–µ.  
    <em>Instructions (EN):</em> Listen, say the missing word (or type it), then press ‚ÄúCheck‚Äù.
  </div>
  <div id="micCaption" class="caption"></div>

  <div id="list"></div>

  <div class="hr"></div>
  <div class="foot muted">Tip: Use the üîä button to hear the sentence. Your answers are checked locally.</div>
</div>

<script>
/* --- 0) URL params --- */
const url = new URL(location.href);
const level   = (url.searchParams.get('level')   || 'A1').toUpperCase();
const unit    = (url.searchParams.get('unit')    || 'L2').toUpperCase();
const section = (url.searchParams.get('section') || 'story').toLowerCase();
document.getElementById('meta').textContent = `${level} ‚Ä¢ ${unit} ‚Ä¢ ${section}`;

/* --- Feature switches (default ON) --- */
let speechOn = true; // mic
let ttsOn    = true; // TTS

/* --- 1) TTS helpers --- */
function normalizeForSpeech(t){
  return String(t)
    .replace(/\([^)]*\)/g, ' ')
    .replace(/‚Üí/g, ' to ')
    .replace(/[‚Ä¢‚óÜ‚ó¶‚ñ†\-‚Äì‚Äî]/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .trim();
}
function toInstructionalSpeech(prompt){
  const hasBlank = /_{1,}/.test(prompt||'');
  const clean = normalizeForSpeech(prompt||'');
  if (hasBlank) return "Complete the sentence: " + clean.replace(/_{1,}/g, " ‚Ä¶ ");
  return clean;
}
let preferredVoice = null;
function pickMaleVoice(){
  const voices = window.speechSynthesis.getVoices?.() || [];
  const byMaleName = voices.find(v => /(male|david|george|guy|daniel|microsoft|google uk english male)/i.test(v.name));
  const byLangEN   = voices.find(v => /^en(-|_)/i.test(v.lang));
  preferredVoice = byMaleName || byLangEN || voices[0] || null;
}
window.speechSynthesis.onvoiceschanged = pickMaleVoice; pickMaleVoice();
function speak(text){
  if (!ttsOn) return;
  try{
    const u = new SpeechSynthesisUtterance(normalizeForSpeech(text));
    if (preferredVoice) u.voice = preferredVoice;
    u.rate = 1.0; u.pitch = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch{}
}

/* --- 1a) Smart feedback --- */
function smartWrongFeedback(){
  return "Not quite. Check the story and try again. / –ù–µ —Ç–æ—á–Ω–æ. –í—ä—Ä–Ω–µ—Ç–µ —Å–µ –∫—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫.";
}

/* --- 2) Helpers: normalize answers --- */
function norm(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[‚Äú‚Äù"‚Äò‚Äô']/g,'"')
    .replace(/[.,!?;:()]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}

/* --- 3) Load + expand JSON to items --- */
async function loadData(level, unit, section){
  const file = section === 'grammar' ? 'data/a1_grammar.json' : 'data/a1.json';
  const res = await fetch(file, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
  const data = await res.json();

  const lessons = data.lessons || {};
  const rawNum = String(unit).replace(/^L/i,'').replace(/^0+/,'');
  const num2   = rawNum.padStart(2,'0');
  const candidates = [unit, unit.toUpperCase(), unit.toLowerCase(),'L'+rawNum,'l'+rawNum,'L'+num2,'l'+num2];
  const key = candidates.find(k => Object.prototype.hasOwnProperty.call(lessons, k)) || null;

  const lesson   = key ? lessons[key] : null;
  if (!lesson) return {blocks:[], defaults:data.feedbackDefaults||{}};

  const blocks = [];
  const defaults = data.feedbackDefaults || {};

  (lesson.exercises || []).forEach((ex, exIdx) => {
    const lines = (ex.payload && Array.isArray(ex.payload.lines)) ? ex.payload.lines.slice() : [];
    if (!lines.length) return;

    const block = { title: ex.title || `Exercise ${exIdx+1}`, sub: null, items: [] };
    const firstInfo = lines.find(s => /fill|translate|rearrange|–ø–æ–¥—Ä–µ–¥–µ—Ç–µ|–ø–æ–ø—ä–ª–Ω–µ—Ç–µ|–ø—Ä–µ–≤–µ–¥–µ—Ç–µ/i.test(s));
    if (firstInfo) block.sub = firstInfo;

    const ansPos = lines.findIndex(s => /^answers\s*:?/i.test(s));
    if (ansPos !== -1){
      const prompts = lines.slice(0, ansPos).filter(s => /___/.test(s));
      const answers = lines.slice(ansPos+1).map(s => s.trim()).filter(Boolean);
      const n = Math.min(prompts.length, answers.length);
      for(let i=0;i<n;i++){
        block.items.push({ kind:'Fill', prompt: prompts[i], answer: answers[i], explain: block.sub || '' });
      }
      blocks.push(block);
      return;
    }

    // Q + "Correct Answer:"
    for(let i=0;i<lines.length;i++){
      const q = lines[i];
      const mQ = /^(.*\?)\s*(?:\(.*?\))?\s*$/i.exec(q);
      const next = lines[i+1] || '';
      const mA = /^\s*(?:correct\s*answer\s*:\s*)(.*)$/i.exec(next);
      if (mQ && mA){
        block.items.push({ kind:'Fill', prompt: mQ[1], answer: mA[1], explain: block.sub || '' });
        i++;
      }
    }
    if (block.items.length) blocks.push(block);
  });

  if (!blocks.length){
    const flat = Array.isArray(lesson.exercises) ? lesson.exercises : [];
    blocks.push({ title: `${unit} ‚Ä¢ ${section}`, sub: null, items: flat });
  }
  return {blocks, defaults};
}

/* --- 4) Render --- */
let allInputs = [];
let activeInput = null;

function setActiveInput(inp){
  activeInput = inp || null;
  if (activeInput) activeInput.focus();
}

function render(blocks){
  const list = document.getElementById('list');
  list.innerHTML = '';
  allInputs = [];
  activeInput = null;

  if(!blocks.length){
    list.innerHTML = `<div class="card"><div class="prompt">No items for ${level}/${unit}/${section}.</div>
    <div class="muted">Check URL parameters or dataset.</div></div>`;
    return;
  }

  blocks.forEach((block, bi) => {
    const head = document.createElement('div');
    head.className = 'card';
    const t = document.createElement('div'); t.className='block-title'; t.textContent = `${bi+1}. ${block.title}`;
    head.appendChild(t);
    if (block.sub){
      const s = document.createElement('div'); s.className='block-sub'; s.textContent = block.sub;
      head.appendChild(s);
    }
    list.appendChild(head);

    block.items.forEach((it, idx) => {
      const card = document.createElement('div'); card.className = 'card';

      const p = document.createElement('div'); p.className = 'prompt';
      p.textContent = `${idx+1}. ${it.prompt || ''}`;
      card.appendChild(p);

      const controls = document.createElement('div'); controls.className = 'controls';

      const listen = document.createElement('button');
      listen.textContent = 'üîä Listen';
      listen.onclick = () => speak(toInstructionalSpeech(it.prompt || ''));
      controls.appendChild(listen);

      let result = document.createElement('div'); result.className='muted';

      const answerUI = document.createElement('input');
      answerUI.type = 'text'; answerUI.placeholder = 'Say or type your answer‚Ä¶ / –ö–∞–∂–µ—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–µ—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∞‚Ä¶';
      answerUI.addEventListener('focus', () => setActiveInput(answerUI));
      if (!activeInput) setActiveInput(answerUI); // –ø—ä—Ä–≤–æ—Ç–æ –ø–æ–ª–µ —Å—Ç–∞–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
      allInputs.push(answerUI);

      const check = document.createElement('button'); check.textContent = 'Check';
      check.onclick = () => {
        const user = norm(answerUI.value||'');
        const gold = norm(it.answer||'');
        const ok = user && gold && user === gold;
        if (ok){
          result.textContent = 'Correct! / –í—è—Ä–Ω–æ!';
          result.className = 'ok';
          speak('Correct! Well done.');
        } else {
          const msg = smartWrongFeedback();
          result.textContent = msg;
          result.className = 'bad';
          speak('Not quite. Check the story and try again.');
        }
      };
      controls.append(answerUI, check);

      // –û–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω –ª–æ–∫–∞–ª–µ–Ω Speak-–±—É—Ç–æ–Ω ‚Äì —Ñ–æ–∫—É—Å–∏—Ä–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–æ—Ç–æ –ø–æ–ª–µ
      const micBtn = document.createElement('button'); micBtn.textContent = 'üéôÔ∏è Speak';
      micBtn.onclick = () => setActiveInput(answerUI);
      controls.appendChild(micBtn);

      const show = document.createElement('button'); show.textContent = 'Show answer';
      show.onclick = () => {
        result.textContent = `Correct answer: ${it.answer||''} / –í–µ—Ä–Ω–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä –µ: ${it.answer||''}.`;
        result.className='muted';
        speak(`Correct answer: ${normalizeForSpeech(it.answer||'')}`);
      };
      controls.appendChild(show);

      card.appendChild(controls);
      card.appendChild(result);
      list.appendChild(card);
    });
  });
}

/* --- 5) Speech Recognition (global, auto ON) --- */
const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let recognizer = null;
let micCaptionEl = document.getElementById('micCaption');

function extractKeyword(text){
  // –í–∑–∏–º–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–∞—Ç–∞ ‚Äû—á–∏—Å—Ç–∞‚Äú –¥—É–º–∞
  const words = String(text||'').toLowerCase().match(/[a-z]+(?:'[a-z]+)?/g);
  if (!words || !words.length) return '';
  return words[words.length-1];
}

function startRecognizer(){
  if (!SpeechRec){ micCaptionEl.innerHTML = '‚ö†Ô∏è Speech recognition is not supported in this browser. / –†–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ä–µ—á –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –≤ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä.'; return; }
  if (recognizer) return;
  recognizer = new SpeechRec();
  recognizer.lang = 'en-US';
  recognizer.interimResults = true;
  recognizer.continuous = true;

  recognizer.onresult = (ev)=>{
    let transcript = '';
    for (let i = ev.resultIndex; i < ev.results.length; i++){
      transcript += ev.results[i][0].transcript;
    }
    micCaptionEl.textContent = `üéôÔ∏è Heard: ${transcript}`;
    if (!speechOn) return;
    const word = extractKeyword(transcript);
    if (word && activeInput){
      activeInput.value = word;
    }
  };
  recognizer.onend = ()=>{
    // –ü–æ–¥–¥—ä—Ä–∂–∞–º–µ –≥–æ –∞–∫—Ç–∏–≤–µ–Ω, –∞–∫–æ –µ ON
    if (speechOn){ try{ recognizer.start(); }catch{} }
  };
  recognizer.onerror = (e)=>{
    micCaptionEl.innerHTML = `‚ö†Ô∏è Mic error: ${e.error}. If permission was denied, enable the microphone in the browser settings. / –†–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.`;
  };

  try {
    recognizer.start();
    micCaptionEl.textContent = 'üéôÔ∏è Listening‚Ä¶ Say the missing word. / –°–ª—É—à–∞–º‚Ä¶ –ö–∞–∂–µ—Ç–µ –ª–∏–ø—Å–≤–∞—â–∞—Ç–∞ –¥—É–º–∞.';
  } catch(e){
    micCaptionEl.innerHTML = 'Click ‚ÄúSpeech: OFF‚Äù to turn it ON. / –©—Ä–∞–∫–Ω–µ—Ç–µ ‚ÄûSpeech: OFF‚Äú, –∑–∞ –¥–∞ –≥–æ –≤–∫–ª—é—á–∏—Ç–µ.';
  }
}

function stopRecognizer(){
  if (recognizer){
    try{ recognizer.stop(); }catch{}
    recognizer = null;
  }
}

/* --- 6) Toggles --- */
const pillSpeech = document.getElementById('pillSpeech');
const pillTTS    = document.getElementById('pillTTS');

function refreshPills(){
  pillSpeech.textContent = `Speech: ${speechOn ? 'ON' : 'OFF'}`;
  pillTTS.textContent    = `TTS: ${ttsOn ? 'ON' : 'OFF'}`;
}
pillSpeech.onclick = ()=>{
  speechOn = !speechOn;
  refreshPills();
  if (speechOn) startRecognizer(); else { stopRecognizer(); micCaptionEl.textContent = 'üéôÔ∏è Speech OFF'; }
};
pillTTS.onclick = ()=>{ ttsOn = !ttsOn; refreshPills(); };

refreshPills();

/* --- 7) Boot --- */
loadData(level, unit, section)
  .then(({blocks}) => {
    render(blocks);
    // —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
    startRecognizer();
  })
  .catch(err => {
    const list = document.getElementById('list');
    list.innerHTML = `<div class="card"><div class="prompt">Error loading data.</div>
    <div class="muted">${String(err)}</div></div>`;
  });
</script>
</body>
</html>
